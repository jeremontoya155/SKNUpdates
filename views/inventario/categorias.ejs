<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Sistema de Inventario</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <%- include('../partials/header') %>

  <main class="container">
    <% if (message) { %>
      <div class="alert alert-success"><%= message %></div>
    <% } %>
    
    <% if (error) { %>
      <div class="alert alert-error"><%= error %></div>
    <% } %>

    <div class="page-header">
      <h1>Categor√≠as de Materiales</h1>
      <a href="/inventario" class="btn btn-secondary">Volver a Inventario</a>
    </div>

    <% if (user.rol === 'skn_admin' || user.rol === 'empresa_admin') { %>
      <div class="categoria-form">
        <h3>‚ûï Nueva Categor√≠a</h3>
        <form action="/inventario/categorias" method="POST">
          <div class="form-row">
            <div class="form-group">
              <label for="nombre">Nombre *</label>
              <input type="text" id="nombre" name="nombre" required placeholder="Ej: Notebooks, Impresoras">
            </div>

            <div class="form-group">
              <label for="descripcion">Descripci√≥n</label>
              <input type="text" id="descripcion" name="descripcion" placeholder="Descripci√≥n de la categor√≠a">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="codigo_prefijo">Prefijo de C√≥digo</label>
              <input type="text" id="codigo_prefijo" name="codigo_prefijo" placeholder="Ej: NB, IMP, PC" maxlength="10">
              <small>Se usar√° para generar c√≥digos autom√°ticos: NB-001, IMP-002, etc.</small>
            </div>

            <div class="form-group">
              <label for="icono">Icono (emoji o texto)</label>
              <input type="text" id="icono" name="icono" placeholder="üíª üì± üñ®Ô∏è" maxlength="5">
            </div>
          </div>

          <button type="submit" class="btn btn-primary">Crear Categor√≠a</button>
        </form>
      </div>
    <% } %>

    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th>Icono</th>
            <th>Nombre</th>
            <th>Descripci√≥n</th>
            <th>Prefijo</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <% categorias.forEach(cat => { %>
            <tr id="cat-row-<%= cat.id %>">
              <td style="font-size: 1.5rem;"><%= cat.icono || 'üì¶' %></td>
              <td><strong><%= cat.nombre %></strong></td>
              <td><%= cat.descripcion || 'Sin descripci√≥n' %></td>
              <td>
                <% if (cat.codigo_prefijo) { %>
                  <span class="badge badge-secondary"><%= cat.codigo_prefijo %></span>
                <% } else { %>
                  -
                <% } %>
              </td>
              <td>
                <% if (cat.activo) { %>
                  <span class="badge badge-success">Activa</span>
                <% } else { %>
                  <span class="badge badge-secondary">Inactiva</span>
                <% } %>
              </td>
              <td>
                <% if (user.rol === 'skn_admin' || user.rol === 'empresa_admin') { %>
                  <button onclick="editarCategoria(<%= cat.id %>, '<%= cat.nombre %>', '<%= cat.descripcion || '' %>', '<%= cat.codigo_prefijo || '' %>', '<%= cat.icono || '' %>')" 
                          class="btn-small btn-warning">‚úèÔ∏è Editar</button>
                <% } %>
                <a href="/inventario/categorias/<%= cat.id %>/atributos" class="btn-small">üìã Atributos</a>
                <% if (user.rol === 'skn_admin' || user.rol === 'empresa_admin') { %>
                  <% if (cat.activo) { %>
                    <button onclick="toggleCategoria(<%= cat.id %>, false)" class="btn-small btn-danger">üö´ Desactivar</button>
                  <% } else { %>
                    <button onclick="toggleCategoria(<%= cat.id %>, true)" class="btn-small btn-success">‚úÖ Activar</button>
                  <% } %>
                <% } %>
              </td>
            </tr>
            
            <!-- Fila de edici√≥n oculta -->
            <tr id="edit-row-<%= cat.id %>" style="display: none;" class="edit-row">
              <td colspan="6" style="background-color: #f8f9fa; padding: 20px;">
                <form action="/inventario/categorias/<%= cat.id %>/editar" method="POST">
                  <h4 style="margin-bottom: 15px;">‚úèÔ∏è Editar Categor√≠a</h4>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Nombre *</label>
                      <input type="text" name="nombre" id="edit-nombre-<%= cat.id %>" required>
                    </div>
                    <div class="form-group">
                      <label>Descripci√≥n</label>
                      <input type="text" name="descripcion" id="edit-descripcion-<%= cat.id %>">
                    </div>
                    <div class="form-group">
                      <label>Prefijo</label>
                      <input type="text" name="codigo_prefijo" id="edit-prefijo-<%= cat.id %>" maxlength="10">
                    </div>
                    <div class="form-group">
                      <label>Icono</label>
                      <input type="text" name="icono" id="edit-icono-<%= cat.id %>" maxlength="5">
                    </div>
                  </div>
                  <div class="form-actions">
                    <button type="submit" class="btn btn-primary">üíæ Guardar</button>
                    <button type="button" onclick="cancelarEdicion(<%= cat.id %>)" class="btn btn-secondary">‚ùå Cancelar</button>
                  </div>
                </form>
              </td>
            </tr>
          <% }) %>

          <% if (categorias.length === 0) { %>
            <tr>
              <td colspan="6" style="text-align: center;">No hay categor√≠as registradas</td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>

    <script>
      function editarCategoria(id, nombre, descripcion, prefijo, icono) {
        // Ocultar fila normal y mostrar fila de edici√≥n
        document.getElementById('cat-row-' + id).style.display = 'none';
        document.getElementById('edit-row-' + id).style.display = 'table-row';
        
        // Llenar campos
        document.getElementById('edit-nombre-' + id).value = nombre;
        document.getElementById('edit-descripcion-' + id).value = descripcion;
        document.getElementById('edit-prefijo-' + id).value = prefijo;
        document.getElementById('edit-icono-' + id).value = icono;
      }

      function cancelarEdicion(id) {
        document.getElementById('cat-row-' + id).style.display = 'table-row';
        document.getElementById('edit-row-' + id).style.display = 'none';
      }

      async function toggleCategoria(id, activar) {
        if (!confirm(`¬øEst√°s seguro de ${activar ? 'activar' : 'desactivar'} esta categor√≠a?`)) {
          return;
        }

        try {
          const response = await fetch(`/inventario/categorias/${id}/toggle`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ activo: activar })
          });

          if (response.ok) {
            location.reload();
          } else {
            alert('Error al actualizar la categor√≠a');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error al actualizar la categor√≠a');
        }
      }
    </script>
  </main>

  <%- include('../partials/footer') %>
</body>
</html>
