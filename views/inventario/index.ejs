<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Sistema de Inventario</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <%- include('../partials/header') %>

  <main class="container">
    <% if (message) { %>
      <div class="alert alert-success"><%= message %></div>
    <% } %>
    
    <% if (error) { %>
      <div class="alert alert-error"><%= error %></div>
    <% } %>

    <div class="page-header">
      <h1>üì¶ Inventario de Materiales y Equipos</h1>
      <div class="actions">
        <% if (user.rol === 'skn_admin' || user.rol === 'empresa_admin') { %>
          <a href="/inventario/nuevo" class="btn btn-primary">+ Nuevo Material</a>
          <a href="/inventario/categorias" class="btn btn-secondary">Categor√≠as</a>
        <% } %>
      </div>
    </div>

    <!-- Indicador de filtro activo -->
    <% if (filtros.empresa && filtros.empresa !== 'todas') { %>
      <div class="alert alert-info" style="display: flex; align-items: center; justify-content: space-between;">
        <span>
          üîç Filtrando por empresa espec√≠fica (<%= materiales.length %> items encontrados)
        </span>
        <a href="/inventario" class="btn btn-small">‚ùå Quitar filtro</a>
      </div>
    <% } %>

    <!-- Buscador y Filtros -->
    <div class="search-filters">
      <form method="GET" action="/inventario" class="search-form">
        <div class="form-row">
          <div class="form-group">
            <input type="text" name="buscar" placeholder="Buscar por nombre o c√≥digo..." 
                   value="<%= filtros.buscar || '' %>" class="search-input">
          </div>

          <div class="form-group">
            <select name="categoria" class="filter-select">
              <option value="">Todas las categor√≠as</option>
              <% categorias.forEach(cat => { %>
                <option value="<%= cat.id %>" <%= filtros.categoria == cat.id ? 'selected' : '' %>>
                  <%= cat.nombre %>
                </option>
              <% }) %>
            </select>
          </div>

          <% if (user.rol === 'skn_admin' || user.rol === 'skn_user') { %>
            <div class="form-group">
              <select name="empresa" class="filter-select">
                <option value="todas">Todas las empresas</option>
                <% empresas.forEach(emp => { %>
                  <option value="<%= emp.id %>" <%= filtros.empresa == emp.id ? 'selected' : '' %>>
                    <%= emp.nombre %>
                  </option>
                <% }) %>
              </select>
            </div>
          <% } %>

          <div class="form-group">
            <select name="stock" class="filter-select">
              <option value="">Todos los stocks</option>
              <option value="bajo" <%= filtros.stock === 'bajo' ? 'selected' : '' %>>Stock Bajo</option>
              <option value="agotado" <%= filtros.stock === 'agotado' ? 'selected' : '' %>>Agotado</option>
            </select>
          </div>

          <button type="submit" class="btn btn-primary">Buscar</button>
          <a href="/inventario" class="btn btn-secondary">Limpiar</a>
        </div>
      </form>
    </div>

    <style>
      /* Scroll horizontal en todos los dispositivos si es necesario */
      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin-top: 20px;
      }

      /* Tabla base */
      .inventario-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 1000px; /* Garantiza scroll en mobile si no cabe */
        table-layout: fixed;
      }
      
      .inventario-table th,
      .inventario-table td {
        padding: 12px 8px;
        text-align: left;
        vertical-align: middle;
        border-bottom: 1px solid #e0e0e0;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      .inventario-table th {
        background: #f8f9fa;
        font-weight: 600;
        font-size: 12px;
        text-transform: uppercase;
        color: #555;
        white-space: nowrap;
        position: sticky;
        top: 0;
        z-index: 10;
      }
      
      /* Columnas con ancho espec√≠fico y fijo */
      .inventario-table .col-codigo { 
        width: 140px;
        max-width: 140px;
      }
      
      .inventario-table .col-nombre { 
        width: 250px;
        max-width: 250px;
        white-space: normal;
      }
      
      .inventario-table .col-categoria { 
        width: 130px;
        max-width: 130px;
      }
      
      .inventario-table .col-empresa { 
        width: 150px;
        max-width: 150px;
      }
      
      .inventario-table .col-ubicacion { 
        width: 160px;
        max-width: 160px;
      }
      
      .inventario-table .col-stock { 
        width: 90px;
        max-width: 90px;
        text-align: center;
      }
      
      .inventario-table .col-acciones { 
        width: 100px;
        max-width: 100px;
        text-align: center;
      }
      
      .codigo-cell {
        font-size: 12px;
        color: #666;
        font-family: 'Courier New', monospace;
        display: block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      /* Asegurar que los badges se vean bien */
      .inventario-table .badge {
        display: inline-block;
        white-space: nowrap;
      }
      
      /* Estilos para filas */
      .inventario-table tbody tr {
        transition: background-color 0.2s ease;
      }
      
      .inventario-table tbody tr:hover {
        background-color: #f5f5f5;
      }
      
      .inventario-table tbody tr.stock-bajo {
        background-color: #fff9e6;
      }
      
      .inventario-table tbody tr.stock-bajo:hover {
        background-color: #fff3cc;
      }

      /* Mobile: mantener scroll horizontal */
      @media (max-width: 768px) {
        .inventario-table th,
        .inventario-table td {
          padding: 10px 6px;
          font-size: 12px;
        }
        
        .inventario-table .col-nombre {
          width: 200px;
          max-width: 200px;
        }
        
        .inventario-table .col-codigo {
          width: 120px;
          max-width: 120px;
        }
      }
    </style>

    <div class="table-container">
      <table class="inventario-table">
        <thead>
          <tr>
            <th class="col-codigo">C√≥digo</th>
            <th class="col-nombre">Nombre</th>
            <th class="col-categoria">Categor√≠a</th>
            <% if (user.rol === 'skn_admin' || user.rol === 'skn_user') { %>
              <th class="col-empresa">Empresa</th>
            <% } %>
            <th class="col-ubicacion">Ubicaci√≥n</th>
            <th class="col-stock">Stock</th>
            <th class="col-acciones">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <% materiales.forEach(material => { %>
            <tr class="<%= material.stock_actual <= material.stock_minimo && material.stock_actual > 0 ? 'stock-bajo' : '' %>">
              <td class="col-codigo">
                <span class="codigo-cell" title="<%= material.codigo || 'Sin c√≥digo' %>">
                  <%= material.codigo || '-' %>
                </span>
              </td>
              <td class="col-nombre">
                <div style="font-weight: 600; margin-bottom: 2px;"><%= material.nombre %></div>
                <% if (material.marca || material.modelo) { %>
                  <div style="font-size: 12px; color: #666;">
                    <%= [material.marca, material.modelo].filter(Boolean).join(' ') %>
                  </div>
                <% } %>
              </td>
              <td class="col-categoria">
                <span class="badge badge-primary" style="font-size: 11px; padding: 4px 8px;">
                  <%= material.categoria_nombre || 'N/A' %>
                </span>
              </td>
              <% if (user.rol === 'skn_admin' || user.rol === 'skn_user') { %>
                <td class="col-empresa" title="<%= material.empresa_nombre || 'Sin empresa' %>">
                  <%= material.empresa_nombre || '-' %>
                </td>
              <% } %>
              <td class="col-ubicacion" title="<%= material.sucursal_nombre || 'Sin sucursal' %>">
                <% if (material.sucursal_nombre) { %>
                  üè™ <%= material.sucursal_nombre %>
                <% } else { %>
                  -
                <% } %>
              </td>
              <td class="col-stock">
                <% if (material.stock_actual === 0) { %>
                  <span class="badge badge-danger"><%= material.stock_actual %></span>
                <% } else if (material.stock_actual <= material.stock_minimo) { %>
                  <span class="badge badge-warning"><%= material.stock_actual %></span>
                <% } else { %>
                  <span class="badge badge-success"><%= material.stock_actual %></span>
                <% } %>
              </td>
              <td class="col-acciones">
                <a href="/inventario/<%= material.id %>" class="btn-small" style="padding: 6px 12px;">Ver</a>
              </td>
            </tr>
          <% }) %>
          
          <% if (materiales.length === 0) { %>
            <tr>
              <td colspan="<%= (user.rol === 'skn_admin' || user.rol === 'skn_user') ? '7' : '6' %>" style="text-align: center; padding: var(--spacing-xl);">
                <div class="empty-state">
                  <p style="font-size: 18px; color: var(--text-secondary);">üì≠ No hay materiales que coincidan con los filtros</p>
                </div>
              </td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </main>

  <%- include('../partials/footer') %>
</body>
</html>
