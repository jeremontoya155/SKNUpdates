<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Sistema de Inventario</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <%- include('../partials/header') %>

  <main class="container">
    <% if (message) { %>
      <div class="alert alert-success"><%= message %></div>
    <% } %>
    
    <% if (error) { %>
      <div class="alert alert-error"><%= error %></div>
    <% } %>

    <div class="page-header">
      <h1>üì¶ Inventario de Materiales y Equipos</h1>
      <div class="actions">
        <% if (user.rol === 'skn_admin' || user.rol === 'empresa_admin') { %>
          <a href="/inventario/nuevo" class="btn btn-primary">+ Nuevo Material</a>
          <a href="/inventario/categorias" class="btn btn-secondary">Categor√≠as</a>
        <% } %>
      </div>
    </div>

    <!-- Indicador de filtro activo -->
    <% if (filtros.empresa && filtros.empresa !== 'todas') { %>
      <div class="alert alert-info" style="display: flex; align-items: center; justify-content: space-between;">
        <span>
          üîç Filtrando por empresa espec√≠fica (<%= materiales.length %> items encontrados)
        </span>
        <a href="/inventario" class="btn btn-small">‚ùå Quitar filtro</a>
      </div>
    <% } %>

    <!-- Buscador y Filtros -->
    <div class="search-filters">
      <form method="GET" action="/inventario" class="search-form">
        <div class="form-row">
          <div class="form-group">
            <input type="text" name="buscar" placeholder="Buscar por nombre o c√≥digo..." 
                   value="<%= filtros.buscar || '' %>" class="search-input">
          </div>

          <div class="form-group">
            <select name="categoria" class="filter-select">
              <option value="">Todas las categor√≠as</option>
              <% categorias.forEach(cat => { %>
                <option value="<%= cat.id %>" <%= filtros.categoria == cat.id ? 'selected' : '' %>>
                  <%= cat.nombre %>
                </option>
              <% }) %>
            </select>
          </div>

          <% if (user.rol === 'skn_admin' || user.rol === 'skn_user') { %>
            <div class="form-group">
              <select name="empresa" class="filter-select">
                <option value="todas">Todas las empresas</option>
                <% empresas.forEach(emp => { %>
                  <option value="<%= emp.id %>" <%= filtros.empresa == emp.id ? 'selected' : '' %>>
                    <%= emp.nombre %>
                  </option>
                <% }) %>
              </select>
            </div>
          <% } %>

          <div class="form-group">
            <select name="stock" class="filter-select">
              <option value="">Todos los stocks</option>
              <option value="bajo" <%= filtros.stock === 'bajo' ? 'selected' : '' %>>Stock Bajo</option>
              <option value="agotado" <%= filtros.stock === 'agotado' ? 'selected' : '' %>>Agotado</option>
            </select>
          </div>

          <button type="submit" class="btn btn-primary">Buscar</button>
          <a href="/inventario" class="btn btn-secondary">Limpiar</a>
        </div>
      </form>
    </div>

    <style>
      /* Scroll horizontal en todos los dispositivos si es necesario */
      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      /* Tabla base */
      .inventario-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 800px; /* Garantiza scroll en mobile si no cabe */
      }
      
      .inventario-table th,
      .inventario-table td {
        padding: 12px;
        text-align: left;
        vertical-align: middle;
        border-bottom: 1px solid #e0e0e0;
      }
      
      .inventario-table th {
        background: #f8f9fa;
        font-weight: 600;
        font-size: 13px;
        text-transform: uppercase;
        color: #555;
        white-space: nowrap;
      }
      
      /* Columnas con ancho espec√≠fico */
      .col-codigo { width: 120px; }
      .col-categoria { width: 130px; }
      .col-empresa { width: 140px; }
      .col-ubicacion { width: 160px; }
      .col-stock { width: 80px; text-align: center; }
      .col-acciones { width: 100px; text-align: center; }
      
      /* Columna nombre flexible */
      .nombre-col {
        min-width: 220px;
        white-space: normal;
      }
      
      .codigo-cell {
        font-size: 12px;
        color: #666;
        font-family: 'Courier New', monospace;
      }

      /* Mobile: mantener scroll horizontal */
      @media (max-width: 768px) {
        .inventario-table th,
        .inventario-table td {
          padding: 10px 8px;
          font-size: 13px;
        }
        
        .nombre-col {
          min-width: 180px;
        }
      }
    </style>

    <div class="table-container">
      <table class="inventario-table">
        <thead>
          <tr>
            <th class="col-codigo">C√≥digo</th>
            <th class="col-nombre">Nombre</th>
            <th class="col-categoria">Categor√≠a</th>
            <% if (user.rol === 'skn_admin' || user.rol === 'skn_user') { %>
              <th class="col-empresa">Empresa</th>
            <% } %>
            <th class="col-ubicacion">Ubicaci√≥n</th>
            <th class="col-stock">Stock</th>
            <th class="col-acciones">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <% materiales.forEach(material => { %>
            <tr class="<%= material.stock_actual <= material.stock_minimo && material.stock_actual > 0 ? 'stock-bajo' : '' %>">
              <td class="codigo-cell" title="<%= material.codigo || 'Sin c√≥digo' %>">
                <%= material.codigo || '-' %>
              </td>
              <td class="nombre-col">
                <div style="font-weight: 600; margin-bottom: 2px;"><%= material.nombre %></div>
                <% if (material.marca || material.modelo) { %>
                  <div style="font-size: 12px; color: #666;">
                    <%= [material.marca, material.modelo].filter(Boolean).join(' ') %>
                  </div>
                <% } %>
              </td>
              <td>
                <span class="badge badge-primary" style="font-size: 11px; padding: 4px 8px;">
                  <%= material.categoria_nombre || 'N/A' %>
                </span>
              </td>
              <% if (user.rol === 'skn_admin' || user.rol === 'skn_user') { %>
                <td title="<%= material.empresa_nombre || 'Sin empresa' %>">
                  <%= material.empresa_nombre || '-' %>
                </td>
              <% } %>
              <td title="<%= material.sucursal_nombre || 'Sin sucursal' %>">
                <% if (material.sucursal_nombre) { %>
                  üè™ <%= material.sucursal_nombre %>
                <% } else { %>
                  -
                <% } %>
              </td>
              <td style="text-align: center;">
                <% if (material.stock_actual === 0) { %>
                  <span class="badge badge-danger"><%= material.stock_actual %></span>
                <% } else if (material.stock_actual <= material.stock_minimo) { %>
                  <span class="badge badge-warning"><%= material.stock_actual %></span>
                <% } else { %>
                  <span class="badge badge-success"><%= material.stock_actual %></span>
                <% } %>
              </td>
              <td style="text-align: center;">
                <a href="/inventario/<%= material.id %>" class="btn-small" style="padding: 6px 12px;">Ver</a>
              </td>
            </tr>
          <% }) %>
          
          <% if (materiales.length === 0) { %>
            <tr>
              <td colspan="<%= (user.rol === 'skn_admin' || user.rol === 'skn_user') ? '7' : '6' %>" style="text-align: center; padding: var(--spacing-xl);">
                <div class="empty-state">
                  <p style="font-size: 18px; color: var(--text-secondary);">üì≠ No hay materiales que coincidan con los filtros</p>
                </div>
              </td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </main>

  <%- include('../partials/footer') %>
</body>
</html>
