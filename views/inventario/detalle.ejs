<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Sistema de Inventario</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <%- include('../partials/header') %>

  <main class="container">
    <% if (message) { %>
      <div class="alert alert-success"><%= message %></div>
    <% } %>
    
    <% if (error) { %>
      <div class="alert alert-error"><%= error %></div>
    <% } %>

    <h1>Detalle de Material</h1>

    <div class="detail-card">
      <h2><%= material.nombre %></h2>
      <p><strong>C√≥digo:</strong> <%= material.codigo || 'N/A' %></p>
      <p><strong>Descripci√≥n:</strong> <%= material.descripcion || 'Sin descripci√≥n' %></p>
      <p><strong>Categor√≠a:</strong> <%= material.categoria_nombre || 'Sin categor√≠a' %></p>
      <p><strong>üè™ Sucursal:</strong> 
        <% if (material.sucursal_nombre) { %>
          <span class="badge badge-info">
            <%= material.sucursal_nombre %><% if (material.sucursal_codigo) { %> (<%= material.sucursal_codigo %>)<% } %>
          </span>
        <% } else { %>
          <span style="color: #999;">Almac√©n Central</span>
        <% } %>
      </p>
      
      <% if (atributos && atributos.length > 0) { %>
        <h3>Caracter√≠sticas</h3>
        <% atributos.forEach(attr => { %>
          <p><strong><%= attr.atributo_nombre %>:</strong> <%= attr.valor %></p>
        <% }) %>
      <% } %>
      
      <p><strong>Stock Actual:</strong> 
        <span class="<%= material.stock_actual <= material.stock_minimo ? 'stock-bajo' : '' %>">
          <%= material.stock_actual %> <%= material.unidad_medida || '' %>
        </span>
      </p>
      <p><strong>Stock M√≠nimo:</strong> <%= material.stock_minimo %> <%= material.unidad_medida || '' %></p>
      <p><strong>Precio Unitario:</strong> $<%= parseFloat(material.precio_unitario).toFixed(2) %></p>
    </div>

    <% if (user.rol === 'skn_admin' || user.rol === 'empresa_admin') { %>
      <div class="movimiento-form">
        <h3>Registrar Movimiento</h3>
        <form action="/inventario/movimiento" method="POST">
          <input type="hidden" name="material_id" value="<%= material.id %>">
          
          <div class="form-row">
            <div class="form-group">
              <label for="tipo_movimiento">Tipo de Movimiento</label>
              <select id="tipo_movimiento" name="tipo_movimiento" required>
                <option value="entrada">Entrada</option>
                <option value="salida">Salida</option>
                <option value="ajuste">Ajuste</option>
              </select>
            </div>

            <div class="form-group">
              <label for="cantidad">Cantidad</label>
              <input type="number" id="cantidad" name="cantidad" required min="1">
            </div>
          </div>

          <div class="form-group">
            <label for="motivo">Motivo</label>
            <textarea id="motivo" name="motivo" rows="2" required></textarea>
          </div>

          <button type="submit" class="btn btn-primary">Registrar Movimiento</button>
        </form>
      </div>
    <% } %>

    <div class="movimientos-historia">
      <h3>Historial de Movimientos</h3>
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Cantidad</th>
            <th>Stock Anterior</th>
            <th>Stock Nuevo</th>
            <th>Usuario</th>
            <th>Motivo</th>
          </tr>
        </thead>
        <tbody>
          <% movimientos.forEach(mov => { %>
            <tr>
              <td><%= new Date(mov.fecha_movimiento).toLocaleString('es-ES') %></td>
              <td><span class="badge badge-<%= mov.tipo_movimiento %>"><%= mov.tipo_movimiento %></span></td>
              <td><%= mov.cantidad %></td>
              <td><%= mov.cantidad_anterior %></td>
              <td><%= mov.cantidad_nueva %></td>
              <td><%= mov.usuario_nombre %></td>
              <td><%= mov.motivo %></td>
            </tr>
          <% }) %>

          <% if (movimientos.length === 0) { %>
            <tr>
              <td colspan="7" style="text-align: center;">No hay movimientos registrados</td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>

    <div class="form-actions">
      <a href="/inventario" class="btn btn-secondary">Volver al Inventario</a>
    </div>
  </main>

  <%- include('../partials/footer') %>
</body>
</html>
