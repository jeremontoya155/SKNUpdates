<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Sistema de Inventario</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <%- include('../partials/header') %>

  <main class="container">
    <div class="page-header">
      <h1>ğŸ¢ GestiÃ³n de Empresas</h1>
      <a href="/empresas/nueva" class="btn btn-primary">â• Nueva Empresa</a>
    </div>

    <% if (message) { %>
      <div class="alert alert-success"><%= message %></div>
    <% } %>
    
    <% if (error) { %>
      <div class="alert alert-error"><%= error %></div>
    <% } %>

    <!-- EstadÃ­sticas Generales -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md); margin-bottom: var(--spacing-xl);">
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: var(--spacing-lg); border-radius: var(--border-radius); box-shadow: var(--box-shadow);">
        <div style="font-size: 36px; font-weight: bold; margin-bottom: 8px;"><%= stats.total || 0 %></div>
        <div style="font-size: 14px; opacity: 0.9;">ğŸ¢ Total Empresas</div>
      </div>
      <div style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; padding: var(--spacing-lg); border-radius: var(--border-radius); box-shadow: var(--box-shadow);">
        <div style="font-size: 36px; font-weight: bold; margin-bottom: 8px;"><%= stats.activas || 0 %></div>
        <div style="font-size: 14px; opacity: 0.9;">âœ… Activas</div>
      </div>
      <div style="background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%); color: white; padding: var(--spacing-lg); border-radius: var(--border-radius); box-shadow: var(--box-shadow);">
        <div style="font-size: 36px; font-weight: bold; margin-bottom: 8px;"><%= stats.abonadas || 0 %></div>
        <div style="font-size: 14px; opacity: 0.9;">ğŸ’³ Abonadas</div>
      </div>
      <div style="background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); color: white; padding: var(--spacing-lg); border-radius: var(--border-radius); box-shadow: var(--box-shadow);">
        <div style="font-size: 36px; font-weight: bold; margin-bottom: 8px;"><%= stats.no_abonadas || 0 %></div>
        <div style="font-size: 14px; opacity: 0.9;">ğŸ’³ No Abonadas</div>
      </div>
    </div>

    <!-- Filtros de bÃºsqueda -->
    <div style="background: white; padding: var(--spacing-lg); border-radius: var(--border-radius); box-shadow: var(--box-shadow); margin-bottom: var(--spacing-xl);">
      <h3 style="margin-top: 0; margin-bottom: var(--spacing-md); color: var(--primary-color);">ğŸ” Filtros de BÃºsqueda</h3>
      <form method="GET" action="/empresas" style="display: grid; gap: var(--spacing-md);">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-md);">
          <!-- BÃºsqueda por texto -->
          <div class="form-group">
            <label for="buscar">ğŸ” Buscar</label>
            <input type="text" id="buscar" name="buscar" placeholder="Nombre, email o CUIT..." 
                   value="<%= filtros?.buscar || '' %>" class="search-input">
          </div>

          <!-- Filtro por estado -->
          <div class="form-group">
            <label for="estado">ğŸ“Š Estado</label>
            <select id="estado" name="estado" class="filter-select">
              <option value="">Todas</option>
              <option value="activas" <%= filtros?.estado === 'activas' ? 'selected' : '' %>>âœ… Solo Activas</option>
              <option value="inactivas" <%= filtros?.estado === 'inactivas' ? 'selected' : '' %>>â¸ï¸ Solo Inactivas</option>
            </select>
          </div>

          <!-- Filtro por abono -->
          <div class="form-group">
            <label for="tipo_abono">ğŸ’³ Tipo de Abono</label>
            <select id="tipo_abono" name="tipo_abono" class="filter-select">
              <option value="">Todas</option>
              <option value="abonadas" <%= filtros?.tipo_abono === 'abonadas' ? 'selected' : '' %>>ğŸ’³ Abonadas</option>
              <option value="no_abonadas" <%= filtros?.tipo_abono === 'no_abonadas' ? 'selected' : '' %>>ğŸ’³ No Abonadas</option>
            </select>
          </div>

          <!-- Ordenamiento -->
          <div class="form-group">
            <label for="orden">ğŸ“‘ Ordenar Por</label>
            <select id="orden" name="orden" class="filter-select">
              <option value="">Nombre A-Z</option>
              <option value="usuarios_desc" <%= filtros?.orden === 'usuarios_desc' ? 'selected' : '' %>>ğŸ‘¥ MÃ¡s Usuarios</option>
              <option value="materiales_desc" <%= filtros?.orden === 'materiales_desc' ? 'selected' : '' %>>ğŸ“¦ MÃ¡s Equipos</option>
              <option value="sucursales_desc" <%= filtros?.orden === 'sucursales_desc' ? 'selected' : '' %>>ğŸª MÃ¡s Sucursales</option>
              <option value="fecha_desc" <%= filtros?.orden === 'fecha_desc' ? 'selected' : '' %>>ğŸ†• MÃ¡s Recientes</option>
            </select>
          </div>
        </div>

        <div style="display: flex; gap: var(--spacing-sm);">
          <button type="submit" class="btn btn-primary">ğŸ” Aplicar Filtros</button>
          <a href="/empresas" class="btn btn-secondary">ğŸ”„ Limpiar</a>
        </div>
      </form>
    </div>

    <!-- Resultados -->
    <div style="margin-bottom: var(--spacing-md);">
      <h3 style="color: var(--text-secondary); font-weight: normal;">
        Mostrando <%= empresas.length %> empresa<%= empresas.length !== 1 ? 's' : '' %>
        <% if (filtros?.buscar || filtros?.estado || filtros?.tipo_abono) { %>
          <span style="color: var(--primary-color);">(filtrado)</span>
        <% } %>
      </h3>
    </div>

    <% if (empresas.length === 0) { %>
      <div class="empty-state">
        <p>ğŸ“­ No hay empresas registradas</p>
        <a href="/empresas/nueva" class="btn btn-primary">Crear primera empresa</a>
      </div>
    <% } else { %>
      <!-- Grid de empresas -->
      <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: var(--spacing-lg); margin-top: var(--spacing-lg);">
        <% empresas.forEach(emp => { %>
          <div class="empresa-card" style="background: white; border-radius: var(--border-radius); box-shadow: var(--box-shadow); padding: var(--spacing-lg); transition: transform 0.3s ease, box-shadow 0.3s ease; border-left: 6px solid <%= emp.activo ? (emp.abonada ? '#4299e1' : '#ed8936') : '#cbd5e0' %>; position: relative; overflow: hidden;">
            
            <!-- Indicador de tipo de empresa (esquina superior derecha) -->
            <% if (emp.abonada) { %>
              <div style="position: absolute; top: 16px; right: -40px; background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%); color: white; padding: 4px 50px; transform: rotate(45deg); font-size: 11px; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                ABONADA
              </div>
            <% } else { %>
              <div style="position: absolute; top: 16px; right: -40px; background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); color: white; padding: 4px 50px; transform: rotate(45deg); font-size: 11px; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                NO ABONADA
              </div>
            <% } %>

            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--spacing-md);">
              <div style="flex: 1; padding-right: 60px;">
                <h3 style="margin: 0 0 8px 0; color: var(--primary-color); font-size: 1.3rem; font-weight: 600;">
                  ğŸ¢ <%= emp.nombre %>
                </h3>
                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px;">
                  <span class="badge <%= emp.activo ? 'badge-success' : 'badge-secondary' %>" style="font-size: 11px;">
                    <%= emp.activo ? 'âœ… Activa' : 'â¸ï¸ Inactiva' %>
                  </span>
                  <span class="badge <%= emp.abonada ? 'badge-primary' : 'badge-warning' %>" style="font-size: 11px; background: <%= emp.abonada ? '#4299e1' : '#ed8936' %>; border: none;">
                    <%= emp.abonada ? 'ğŸ’³ ABONADA' : 'âš ï¸ NO ABONADA' %>
                  </span>
                  <% if (emp.tickets_abiertos && parseInt(emp.tickets_abiertos) > 0) { %>
                    <span class="badge badge-danger" style="font-size: 11px;">
                      ğŸ« <%= emp.tickets_abiertos %> Tickets
                    </span>
                  <% } %>
                </div>
                <% if (emp.cuit) { %>
                  <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">
                    ğŸ“„ CUIT: <%= emp.cuit %>
                  </div>
                <% } %>
              </div>
              <div style="display: flex; gap: 4px; flex-direction: column;">
                <form action="/empresas/<%= emp.id %>/toggle" method="POST" style="margin: 0;">
                  <button type="submit" class="btn-small <%= emp.activo ? 'btn-warning' : 'btn-success' %>" title="<%= emp.activo ? 'Desactivar' : 'Activar' %>" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 18px;">
                    <%= emp.activo ? 'â¸ï¸' : 'âœ…' %>
                  </button>
                </form>
                <% if (user.rol === 'skn_admin') { %>
                  <form action="/empresas/<%= emp.id %>/toggle-abonada" method="POST" style="margin: 0;">
                    <button type="submit" class="btn-small btn-info" title="Cambiar estado de abonada" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 18px; background: <%= emp.abonada ? '#ed8936' : '#4299e1' %>;">
                      ğŸ’³
                    </button>
                  </form>
                <% } %>
              </div>
            </div>

            <!-- Info de contacto -->
            <div style="margin-bottom: var(--spacing-md); padding: var(--spacing-sm) 0; border-bottom: 1px solid var(--border-color);">
              <% if (emp.email) { %>
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                  <span style="color: var(--text-secondary); font-size: 16px;">ğŸ“§</span>
                  <span style="font-size: 13px; color: var(--text-primary);"><%= emp.email %></span>
                </div>
              <% } %>
              <% if (emp.telefono) { %>
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                  <span style="color: var(--text-secondary); font-size: 16px;">ğŸ“</span>
                  <span style="font-size: 13px; color: var(--text-primary);"><%= emp.telefono %></span>
                </div>
              <% } %>
              <% if (emp.direccion) { %>
                <div style="display: flex; align-items: start; gap: 8px;">
                  <span style="color: var(--text-secondary); font-size: 16px;">ğŸ“</span>
                  <span style="font-size: 13px; color: var(--text-primary); line-height: 1.4;">
                    <%= emp.direccion %>
                    <% if (emp.ciudad) { %>, <%= emp.ciudad %><% } %>
                    <% if (emp.provincia) { %>, <%= emp.provincia %><% } %>
                  </span>
                </div>
              <% } %>
            </div>

            <!-- EstadÃ­sticas -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--spacing-sm); margin-bottom: var(--spacing-md);">
              <div style="text-align: center; padding: var(--spacing-sm); background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); border-radius: 8px; border: 1px solid #e2e8f0;">
                <div style="font-size: 28px; font-weight: bold; color: #667eea;"><%= emp.total_usuarios || 0 %></div>
                <div style="font-size: 11px; color: var(--text-secondary); font-weight: 500;">ğŸ‘¥ Usuarios</div>
              </div>
              <div style="text-align: center; padding: var(--spacing-sm); background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); border-radius: 8px; border: 1px solid #e2e8f0;">
                <div style="font-size: 28px; font-weight: bold; color: #48bb78;"><%= emp.total_materiales || 0 %></div>
                <div style="font-size: 11px; color: var(--text-secondary); font-weight: 500;">ğŸ“¦ Equipos</div>
              </div>
              <div style="text-align: center; padding: var(--spacing-sm); background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); border-radius: 8px; border: 1px solid #e2e8f0;">
                <div style="font-size: 28px; font-weight: bold; color: #4299e1;"><%= emp.total_sucursales || 0 %></div>
                <div style="font-size: 11px; color: var(--text-secondary); font-weight: 500;">ğŸª Sucursales</div>
              </div>
            </div>

            <!-- Indicador de tipo de servicio -->
            <div style="background: <%= emp.abonada ? 'linear-gradient(135deg, #e6f2ff 0%, #d6eaff 100%)' : 'linear-gradient(135deg, #fff5e6 0%, #ffe6cc 100%)' %>; padding: var(--spacing-sm); border-radius: 8px; margin-bottom: var(--spacing-md); text-align: center; border: 1px solid <%= emp.abonada ? '#4299e1' : '#ed8936' %>;">
              <div style="font-size: 12px; font-weight: bold; color: <%= emp.abonada ? '#2c5282' : '#9c4221' %>;">
                <%= emp.abonada ? 'âœ¨ Servicio Premium - Visitas presenciales incluidas' : 'âš ï¸ Servicio BÃ¡sico - Visitas presenciales requieren autorizaciÃ³n' %>
              </div>
            </div>

            <!-- Botones de AcciÃ³n -->
            <div style="display: flex; gap: 8px;">
              <a href="/empresas/<%= emp.id %>" class="btn btn-primary" style="flex: 1; text-align: center; font-size: 14px;">
                ğŸ‘ï¸ Ver Detalle
              </a>
              <a href="/empresas/<%= emp.id %>/editar" class="btn btn-secondary" style="padding: 10px 16px; font-size: 18px;">
                âœï¸
              </a>
            </div>
          </div>
        <% }) %>
      </div>
    <% } %>

    <style>
      .empresa-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      }

      @media (max-width: 768px) {
        .empresa-card {
          margin-bottom: var(--spacing-md);
        }
      }
    </style>
  </main>

  <%- include('../partials/footer') %>
</body>
</html>
