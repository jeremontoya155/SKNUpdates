<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Sistema de Inventario</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <%- include('../partials/header') %>

  <main class="container">
    <div class="page-header">
      <h1> Nuevo Ticket</h1>
      <a href="/tickets" class="btn btn-secondary">猬锔 Volver</a>
    </div>

    <% if (!esSKN) { %>
      <div class="alert alert-info">
        癸 El ticket ser谩 asignado a tu empresa autom谩ticamente. SKN se encargar谩 de resolverlo.
      </div>
    <% } %>

    <% if (error) { %>
      <div class="alert alert-error"><%= error %></div>
    <% } %>

    <form action="/tickets/nuevo" method="POST" enctype="multipart/form-data" class="form">
      <% if (esSKN) { %>
        <div class="form-group">
          <label for="empresa_id">Empresa *</label>
          <select id="empresa_id" name="empresa_id" required>
            <option value="">Seleccionar empresa</option>
            <% empresas.forEach(emp => { %>
              <option value="<%= emp.id %>"><%= emp.nombre %></option>
            <% }) %>
          </select>
          <small> Como usuario SKN, puedes crear tickets para cualquier empresa</small>
        </div>
      <% } else { %>
        <div class="alert alert-warning">
           Empresa: <strong><%= user.empresa_nombre %></strong>
        </div>
      <% } %>

      <div class="form-group">
        <label for="tipo_soporte">Tipo de Soporte *</label>
        <select id="tipo_soporte" name="tipo_soporte" required onchange="updateSituaciones()">
          <option value="remoto"> Remoto - Soporte a distancia</option>
          <option value="fisico"> F铆sico - Visita presencial al lugar</option>
        </select>
        <small id="tipo-soporte-info"> Selecciona si el problema requiere asistencia presencial o puede resolverse remotamente</small>
      </div>

      <div class="form-group" id="situacion-container">
        <label for="situacion_soporte_id">Situaci贸n Espec铆fica *</label>
        <select id="situacion_soporte_id" name="situacion_soporte_id">
          <option value="">Seleccione una situaci贸n...</option>
        </select>
        <small id="situacion-descripcion"></small>
      </div>

      <div class="form-group">
        <label for="tipo_trabajo_id">Tipo de Trabajo</label>
        <select id="tipo_trabajo_id" name="tipo_trabajo_id">
          <option value="">Sin especificar</option>
          <% tiposTrabajo.forEach(tipo => { %>
            <option value="<%= tipo.id %>"><%= tipo.nombre %> - <%= tipo.descripcion %></option>
          <% }) %>
        </select>
        <small> Opcional: 驴Qu茅 tipo de trabajo es? (Instalaci贸n, Reparaci贸n, etc.)</small>
      </div>

      <div class="form-group">
        <label for="titulo">T铆tulo *</label>
        <input type="text" id="titulo" name="titulo" required placeholder="Resumen breve del problema">
      </div>

      <div class="form-group">
        <label for="descripcion">Descripci贸n *</label>
        <textarea id="descripcion" name="descripcion" rows="5" required placeholder="Describe el problema o solicitud en detalle"></textarea>
      </div>

      <div class="form-group">
        <label for="prioridad">Prioridad</label>
        <select id="prioridad" name="prioridad">
          <option value="baja"> Baja</option>
          <option value="media" selected> Media</option>
          <option value="alta"> Alta</option>
          <option value="urgente"> Urgente</option>
        </select>
      </div>

      <div class="form-group">
        <label for="imagen_inicial">
           Imagen del Problema (Opcional)
        </label>
        <input type="file" id="imagen_inicial" name="imagen_inicial" accept="image/jpeg,image/jpg,image/png,image/webp">
        <small> Puedes adjuntar una foto del problema. Las im谩genes ser谩n requeridas para cerrar tickets presenciales. M谩ximo 10MB.</small>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary"> Crear Ticket</button>
        <a href="/tickets" class="btn btn-secondary">Cancelar</a>
      </div>
    </form>
  </main>

  <%- include('../partials/footer') %>
  
  <script>
    // Datos de situaciones desde el servidor
    const situaciones = <%- JSON.stringify(situaciones || []) %>;

    function updateSituaciones() {
      const tipoSoporte = document.getElementById('tipo_soporte').value;
      const situacionSelect = document.getElementById('situacion_soporte_id');
      const situacionDescripcion = document.getElementById('situacion-descripcion');
      
      // Determinar el tipo correcto ('remoto' o 'presencial' basado en 'fisico')
      const tipoFiltro = tipoSoporte === 'fisico' ? 'presencial' : 'remoto';
      
      // Filtrar situaciones por tipo
      const situacionesFiltradas = situaciones.filter(s => s.tipo_soporte === tipoFiltro);
      
      // Limpiar y llenar el select
      situacionSelect.innerHTML = '<option value="">Seleccione una situaci贸n...</option>';
      
      situacionesFiltradas.forEach(sit => {
        const option = document.createElement('option');
        option.value = sit.id;
        option.textContent = sit.nombre;
        option.dataset.descripcion = sit.descripcion || '';
        option.dataset.color = sit.color;
        situacionSelect.appendChild(option);
      });
      
      situacionDescripcion.textContent = '';
    }

    // Mostrar descripci贸n de situaci贸n seleccionada
    document.getElementById('situacion_soporte_id').addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      const descripcion = selectedOption.dataset.descripcion;
      const situacionDescripcion = document.getElementById('situacion-descripcion');
      
      if (descripcion) {
        situacionDescripcion.textContent = ' ' + descripcion;
        situacionDescripcion.style.color = selectedOption.dataset.color || '#3498db';
      } else {
        situacionDescripcion.textContent = '';
      }
    });

    // Inicializar al cargar la p谩gina
    document.addEventListener('DOMContentLoaded', function() {
      updateSituaciones();
    });
    
    // Ejecutar al cargar la p谩gina
    document.addEventListener('DOMContentLoaded', toggleImagenRequerida);
  </script>
</body>
</html>
