<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Sistema de Inventario</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <%- include('../partials/header') %>

  <main class="container">
    <div class="page-header">
      <h1>ğŸ« Nuevo Ticket</h1>
      <a href="/tickets" class="btn btn-secondary">â¬…ï¸ Volver</a>
    </div>

    <% if (!esSKN) { %>
      <div class="alert alert-info">
        â„¹ï¸ El ticket serÃ¡ asignado a tu empresa automÃ¡ticamente. SKN se encargarÃ¡ de resolverlo.
      </div>
    <% } %>

    <% if (error) { %>
      <div class="alert alert-error"><%= error %></div>
    <% } %>

    <form action="/tickets/nuevo" method="POST" enctype="multipart/form-data" class="form">
      <% if (esSKN) { %>
        <div class="form-group">
          <label for="empresa_id">Empresa *</label>
          <select id="empresa_id" name="empresa_id" required>
            <option value="">Seleccionar empresa</option>
            <% empresas.forEach(emp => { %>
              <option value="<%= emp.id %>"><%= emp.nombre %></option>
            <% }) %>
          </select>
          <small>ğŸ’¡ Como usuario SKN, puedes crear tickets para cualquier empresa</small>
        </div>
      <% } else { %>
        <div class="alert alert-warning">
          ğŸ¢ Empresa: <strong><%= user.empresa_nombre %></strong>
        </div>
      <% } %>

      <div class="form-group">
        <label for="tipo_soporte">Tipo de Soporte *</label>
        <select id="tipo_soporte" name="tipo_soporte" required onchange="toggleImagenRequerida()">
          <option value="remoto">ğŸ’» Remoto - Soporte a distancia</option>
          <option value="fisico">ğŸ¢ FÃ­sico - Visita presencial al lugar</option>
        </select>
        <small id="tipo-soporte-info">ğŸ’¡ Selecciona si el problema requiere asistencia presencial o puede resolverse remotamente</small>
      </div>

      <div class="form-group">
        <label for="tipo_trabajo_id">Tipo de Trabajo</label>
        <select id="tipo_trabajo_id" name="tipo_trabajo_id">
          <option value="">Sin especificar</option>
          <% tiposTrabajo.forEach(tipo => { %>
            <option value="<%= tipo.id %>"><%= tipo.nombre %> - <%= tipo.descripcion %></option>
          <% }) %>
        </select>
        <small>ğŸ’¡ Opcional: Â¿QuÃ© tipo de trabajo es? (InstalaciÃ³n, ReparaciÃ³n, etc.)</small>
      </div>

      <div class="form-group">
        <label for="titulo">TÃ­tulo *</label>
        <input type="text" id="titulo" name="titulo" required placeholder="Resumen breve del problema">
      </div>

      <div class="form-group">
        <label for="descripcion">DescripciÃ³n *</label>
        <textarea id="descripcion" name="descripcion" rows="5" required placeholder="Describe el problema o solicitud en detalle"></textarea>
      </div>

      <div class="form-group">
        <label for="prioridad">Prioridad</label>
        <select id="prioridad" name="prioridad">
          <option value="baja">ğŸŸ¢ Baja</option>
          <option value="media" selected>ğŸŸ¡ Media</option>
          <option value="alta">ğŸŸ  Alta</option>
          <option value="urgente">ğŸ”´ Urgente</option>
        </select>
      </div>

      <div class="form-group">
        <label for="imagen_inicial">
          ğŸ“· Imagen del Problema 
          <span id="imagen-requerida" style="display: none; color: red;">*</span>
          <span id="imagen-opcional">(Opcional)</span>
        </label>
        <input type="file" id="imagen_inicial" name="imagen_inicial" accept="image/jpeg,image/jpg,image/png,image/webp">
        <small id="imagen-info">ğŸ’¡ Adjunta una foto del problema para ayudar a resolver el ticket mÃ¡s rÃ¡pido. MÃ¡ximo 10MB.</small>
        <small id="imagen-info-fisico" style="display: none; color: #d32f2f; font-weight: bold;">
          âš ï¸ Para soporte fÃ­sico es OBLIGATORIO adjuntar una imagen del problema inicial.
        </small>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary">ğŸ’¾ Crear Ticket</button>
        <a href="/tickets" class="btn btn-secondary">Cancelar</a>
      </div>
    </form>
  </main>

  <%- include('../partials/footer') %>
  
  <script>
    function toggleImagenRequerida() {
      const tipoSoporte = document.getElementById('tipo_soporte').value;
      const imagenInput = document.getElementById('imagen_inicial');
      const imagenRequerida = document.getElementById('imagen-requerida');
      const imagenOpcional = document.getElementById('imagen-opcional');
      const imagenInfo = document.getElementById('imagen-info');
      const imagenInfoFisico = document.getElementById('imagen-info-fisico');
      
      if (tipoSoporte === 'fisico') {
        imagenInput.required = true;
        imagenRequerida.style.display = 'inline';
        imagenOpcional.style.display = 'none';
        imagenInfo.style.display = 'none';
        imagenInfoFisico.style.display = 'block';
      } else {
        imagenInput.required = false;
        imagenRequerida.style.display = 'none';
        imagenOpcional.style.display = 'inline';
        imagenInfo.style.display = 'block';
        imagenInfoFisico.style.display = 'none';
      }
    }
    
    // Ejecutar al cargar la pÃ¡gina
    document.addEventListener('DOMContentLoaded', toggleImagenRequerida);
  </script>
</body>
</html>
