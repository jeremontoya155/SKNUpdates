<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Sistema de Inventario</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <%- include('../partials/header') %>

  <main class="container">
    <div class="page-header">
      <h1> Nuevo Ticket</h1>
      <a href="/tickets" class="btn btn-secondary">猬锔 Volver</a>
    </div>

    <% if (!esSKN) { %>
      <div class="alert alert-info">
        癸 El ticket ser谩 asignado a tu empresa autom谩ticamente. SKN se encargar谩 de resolverlo.
      </div>
    <% } %>

    <% if (error) { %>
      <div class="alert alert-error"><%= error %></div>
    <% } %>

    <form action="/tickets/nuevo" method="POST" enctype="multipart/form-data" class="form">
      <% if (esSKN) { %>
        <div class="form-group">
          <label for="empresa_id">Empresa *</label>
          <select id="empresa_id" name="empresa_id" required onchange="cargarSucursales()">
            <option value="">Seleccionar empresa</option>
            <% empresas.forEach(emp => { %>
              <option value="<%= emp.id %>"><%= emp.nombre %></option>
            <% }) %>
          </select>
          <small> Como usuario SKN, puedes crear tickets para cualquier empresa</small>
        </div>

        <div class="form-group" id="sucursal-group" style="display: none;">
          <label for="sucursal_id">Sucursal / Sede</label>
          <select id="sucursal_id" name="sucursal_id">
            <option value="">Sin especificar</option>
          </select>
          <small id="sucursal-info"></small>
        </div>

        <div class="form-group">
          <label for="tecnicos_ids">Asignar T茅cnicos (Opcional)</label>
          <select id="tecnicos_ids" name="tecnicos_ids" multiple size="5">
            <% tecnicos.forEach(tec => { %>
              <option value="<%= tec.id %>"><%= tec.nombre %></option>
            <% }) %>
          </select>
          <small> Mant茅n presionado Ctrl (Windows) o Cmd (Mac) para seleccionar m煤ltiples t茅cnicos</small>
        </div>
      <% } else { %>
        <div class="alert alert-warning">
           Empresa: <strong><%= user.empresa_nombre %></strong>
        </div>

        <% if (sucursales && sucursales.length > 0) { %>
          <div class="form-group">
            <label for="sucursal_id">Sucursal / Sede donde se registra la tarea *</label>
            <select id="sucursal_id" name="sucursal_id" required onchange="mostrarDireccion()">
              <option value="">Seleccionar sucursal</option>
              <% sucursales.forEach(suc => { %>
                <option value="<%= suc.id %>" 
                        data-direccion="<%= suc.direccion %>" 
                        data-ciudad="<%= suc.ciudad || '' %>" 
                        data-provincia="<%= suc.provincia || '' %>">
                  <%= suc.nombre %>
                </option>
              <% }) %>
            </select>
            <small id="sucursal-info" class="info-direccion"></small>
          </div>
        <% } %>
      <% } %>

      <div class="form-group">
        <label for="tipo_soporte">Tipo de Soporte *</label>
        <select id="tipo_soporte" name="tipo_soporte" required onchange="updateSituaciones()">
          <option value="remoto"> Remoto - Soporte a distancia</option>
          <option value="fisico"> F铆sico - Visita presencial al lugar</option>
        </select>
        <small id="tipo-soporte-info"> Selecciona si el problema requiere asistencia presencial o puede resolverse remotamente</small>
      </div>

      <div class="form-group" id="situacion-container">
        <label for="situacion_soporte_id">Situaci贸n Espec铆fica *</label>
        <select id="situacion_soporte_id" name="situacion_soporte_id">
          <option value="">Seleccione una situaci贸n...</option>
        </select>
        <small id="situacion-descripcion"></small>
      </div>

      <div class="form-group">
        <label for="tipo_trabajo_id">Tipo de Trabajo</label>
        <select id="tipo_trabajo_id" name="tipo_trabajo_id">
          <option value="">Sin especificar</option>
          <% tiposTrabajo.forEach(tipo => { %>
            <option value="<%= tipo.id %>"><%= tipo.nombre %> - <%= tipo.descripcion %></option>
          <% }) %>
        </select>
        <small> Opcional: 驴Qu茅 tipo de trabajo es? (Instalaci贸n, Reparaci贸n, etc.)</small>
      </div>

      <div class="form-group">
        <label for="titulo">T铆tulo *</label>
        <input type="text" id="titulo" name="titulo" required placeholder="Resumen breve del problema">
      </div>

      <div class="form-group">
        <label for="descripcion">Descripci贸n *</label>
        <textarea id="descripcion" name="descripcion" rows="5" required placeholder="Describe el problema o solicitud en detalle"></textarea>
      </div>

      <div class="form-group">
        <label for="prioridad">Prioridad</label>
        <select id="prioridad" name="prioridad">
          <option value="baja"> Baja</option>
          <option value="media" selected> Media</option>
          <option value="alta"> Alta</option>
          <option value="urgente"> Urgente</option>
        </select>
      </div>

      <div class="form-group">
        <label for="imagen_inicial">
           Imagen del Problema (Opcional)
        </label>
        <input type="file" id="imagen_inicial" name="imagen_inicial" accept="image/jpeg,image/jpg,image/png,image/webp">
        <small> Puedes adjuntar una foto del problema. Las im谩genes ser谩n requeridas para cerrar tickets presenciales. M谩ximo 10MB.</small>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary"> Crear Ticket</button>
        <a href="/tickets" class="btn btn-secondary">Cancelar</a>
      </div>
    </form>
  </main>

  <%- include('../partials/footer') %>
  
  <script>
    // Datos de situaciones desde el servidor
    const situaciones = <%- JSON.stringify(situaciones || []) %>;

    // Cargar sucursales cuando se selecciona una empresa (solo para SKN)
    async function cargarSucursales() {
      const empresaId = document.getElementById('empresa_id').value;
      const sucursalGroup = document.getElementById('sucursal-group');
      const sucursalSelect = document.getElementById('sucursal_id');
      
      if (!empresaId) {
        sucursalGroup.style.display = 'none';
        return;
      }
      
      try {
        const response = await fetch(`/tickets/api/sucursales/${empresaId}`);
        const sucursales = await response.json();
        
        sucursalSelect.innerHTML = '<option value="">Sin especificar</option>';
        
        if (sucursales.length > 0) {
          sucursales.forEach(suc => {
            const option = document.createElement('option');
            option.value = suc.id;
            option.textContent = suc.nombre;
            option.dataset.direccion = suc.direccion || '';
            option.dataset.ciudad = suc.ciudad || '';
            option.dataset.provincia = suc.provincia || '';
            sucursalSelect.appendChild(option);
          });
          sucursalGroup.style.display = 'block';
        } else {
          sucursalGroup.style.display = 'none';
        }
        
        // Agregar evento para mostrar direcci贸n
        sucursalSelect.addEventListener('change', mostrarDireccion);
      } catch (error) {
        console.error('Error al cargar sucursales:', error);
      }
    }

    // Mostrar direcci贸n de la sucursal seleccionada
    function mostrarDireccion() {
      const select = document.getElementById('sucursal_id');
      const selectedOption = select.options[select.selectedIndex];
      const infoDiv = document.getElementById('sucursal-info');
      
      if (selectedOption.value && selectedOption.dataset.direccion) {
        let direccion = ` ${selectedOption.dataset.direccion}`;
        if (selectedOption.dataset.ciudad) {
          direccion += `, ${selectedOption.dataset.ciudad}`;
        }
        if (selectedOption.dataset.provincia) {
          direccion += `, ${selectedOption.dataset.provincia}`;
        }
        infoDiv.textContent = direccion;
        infoDiv.style.color = '#2ecc71';
        infoDiv.style.fontWeight = 'bold';
      } else {
        infoDiv.textContent = '';
      }
    }

    function updateSituaciones() {
      const tipoSoporte = document.getElementById('tipo_soporte').value;
      const situacionSelect = document.getElementById('situacion_soporte_id');
      const situacionDescripcion = document.getElementById('situacion-descripcion');
      
      // Determinar el tipo correcto ('remoto' o 'presencial' basado en 'fisico')
      const tipoFiltro = tipoSoporte === 'fisico' ? 'presencial' : 'remoto';
      
      // Filtrar situaciones por tipo
      const situacionesFiltradas = situaciones.filter(s => s.tipo_soporte === tipoFiltro);
      
      // Limpiar y llenar el select
      situacionSelect.innerHTML = '<option value="">Seleccione una situaci贸n...</option>';
      
      situacionesFiltradas.forEach(sit => {
        const option = document.createElement('option');
        option.value = sit.id;
        option.textContent = sit.nombre;
        option.dataset.descripcion = sit.descripcion || '';
        option.dataset.color = sit.color;
        situacionSelect.appendChild(option);
      });
      
      situacionDescripcion.textContent = '';
    }

    // Mostrar descripci贸n de situaci贸n seleccionada
    document.getElementById('situacion_soporte_id').addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      const descripcion = selectedOption.dataset.descripcion;
      const situacionDescripcion = document.getElementById('situacion-descripcion');
      
      if (descripcion) {
        situacionDescripcion.textContent = ' ' + descripcion;
        situacionDescripcion.style.color = selectedOption.dataset.color || '#3498db';
      } else {
        situacionDescripcion.textContent = '';
      }
    });

    // Inicializar al cargar la p谩gina
    document.addEventListener('DOMContentLoaded', function() {
      updateSituaciones();
      // Si no es SKN y hay sucursales, mostrar direcci贸n de la primera seleccionada
      <% if (!esSKN && sucursales && sucursales.length > 0) { %>
        const sucursalSelect = document.getElementById('sucursal_id');
        if (sucursalSelect) {
          sucursalSelect.addEventListener('change', mostrarDireccion);
        }
      <% } %>
    });
  </script>
</body>
</html>
