<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Sistema de Inventario</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <%- include('../partials/header') %>

  <main class="container">
    <% if (message) { %>
      <div class="alert alert-success"><%= message %></div>
    <% } %>
    
    <% if (error) { %>
      <div class="alert alert-error"><%= error %></div>
    <% } %>

    <div class="page-header">
      <h1>ğŸ« Tickets / Solicitudes</h1>
      <a href="/tickets/nuevo" class="btn btn-primary">â• Nuevo Ticket</a>
    </div>

    <% if (esSKN) { %>
      <div class="alert alert-info">
        â„¹ï¸ Como usuario SKN, ves TODOS los tickets de todas las empresas. Puedes asignÃ¡rtelos y cambiar su estado.
      </div>
    <% } else { %>
      <div class="alert alert-info">
        â„¹ï¸ Visualizando tickets de tu empresa. Solo puedes crear tickets y agregar comentarios. SKN gestiona los estados.
      </div>
    <% } %>

    <!-- Filtros de bÃºsqueda -->
    <div class="search-filters">
      <form method="GET" action="/tickets" class="search-form">
        <div class="form-row">
          <div class="form-group">
            <input type="text" name="buscar" placeholder="ğŸ” Buscar por tÃ­tulo o descripciÃ³n..." 
                   value="<%= filtros?.buscar || '' %>" class="search-input">
          </div>

          <div class="form-group">
            <select name="estado" class="filter-select">
              <option value="">ğŸ“‹ Todos los estados</option>
              <option value="abierto" <%= filtros?.estado === 'abierto' ? 'selected' : '' %>>â³ Abierto</option>
              <option value="en_proceso" <%= filtros?.estado === 'en_proceso' ? 'selected' : '' %>>ğŸ”„ En Proceso</option>
              <option value="cerrado" <%= filtros?.estado === 'cerrado' ? 'selected' : '' %>>âœ… Cerrado</option>
              <option value="cancelado" <%= filtros?.estado === 'cancelado' ? 'selected' : '' %>>â›” Cancelado</option>
            </select>
          </div>

          <div class="form-group">
            <select name="prioridad" class="filter-select">
              <option value="">ğŸ¯ Todas las prioridades</option>
              <option value="baja" <%= filtros?.prioridad === 'baja' ? 'selected' : '' %>>ğŸŸ¢ Baja</option>
              <option value="media" <%= filtros?.prioridad === 'media' ? 'selected' : '' %>>ğŸŸ¡ Media</option>
              <option value="alta" <%= filtros?.prioridad === 'alta' ? 'selected' : '' %>>ğŸŸ  Alta</option>
              <option value="urgente" <%= filtros?.prioridad === 'urgente' ? 'selected' : '' %>>ğŸ”´ Urgente</option>
            </select>
          </div>

          <% if (esSKN && empresas && empresas.length > 0) { %>
            <div class="form-group">
              <select name="empresa" class="filter-select">
                <option value="">ğŸ¢ Todas las empresas</option>
                <% empresas.forEach(emp => { %>
                  <option value="<%= emp.id %>" <%= filtros?.empresa == emp.id ? 'selected' : '' %>>
                    <%= emp.nombre %>
                  </option>
                <% }) %>
              </select>
            </div>
          <% } %>

          <% if (esSKN && tecnicos && tecnicos.length > 0) { %>
            <div class="form-group">
              <select name="asignado" class="filter-select">
                <option value="">ğŸ‘¤ Todos los tÃ©cnicos</option>
                <% tecnicos.forEach(tec => { %>
                  <option value="<%= tec.id %>" <%= filtros?.asignado == tec.id ? 'selected' : '' %>>
                    <%= tec.nombre %>
                  </option>
                <% }) %>
              </select>
            </div>
          <% } %>

          <% if (esSKN) { %>
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" name="sin_asignar" value="true" 
                       <%= filtros?.sin_asignar === 'true' ? 'checked' : '' %>>
                ğŸ“‹ Sin asignar
              </label>
            </div>
          <% } %>

          <div class="form-group">
            <input type="date" name="fecha_desde" placeholder="Desde" 
                   value="<%= filtros?.fecha_desde || '' %>" class="filter-input">
          </div>

          <div class="form-group">
            <input type="date" name="fecha_hasta" placeholder="Hasta" 
                   value="<%= filtros?.fecha_hasta || '' %>" class="filter-input">
          </div>

          <button type="submit" class="btn btn-primary">ğŸ” Buscar</button>
          <a href="/tickets" class="btn btn-secondary">ğŸ”„ Limpiar</a>
        </div>
      </form>
    </div>

    <% if (tickets.length === 0) { %>
      <div class="empty-state">
        <p>ğŸ“­ No hay tickets registrados</p>
        <a href="/tickets/nuevo" class="btn btn-primary">Crear primer ticket</a>
      </div>
    <% } else { %>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <% if (esSKN) { %>
                <th>Empresa</th>
              <% } %>
              <th>TÃ­tulo</th>
              <th>Solicitante</th>
              <th>Estado</th>
              <th>Prioridad</th>
              <th>Asignado a</th>
              <th>Fecha</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <% tickets.forEach(ticket => { 
              let estadoBadge = '';
              let estadoTexto = '';
              if (ticket.estado === 'abierto') {
                estadoBadge = 'badge-warning';
                estadoTexto = 'â³ Abierto';
              } else if (ticket.estado === 'en_proceso') {
                estadoBadge = 'badge-primary';
                estadoTexto = 'ğŸ”„ En Proceso';
              } else if (ticket.estado === 'cerrado') {
                estadoBadge = 'badge-success';
                estadoTexto = 'âœ… Cerrado';
              } else if (ticket.estado === 'cancelado') {
                estadoBadge = 'badge';
                estadoTexto = 'â›” Cancelado';
              }

              let prioridadBadge = '';
              let prioridadTexto = '';
              if (ticket.prioridad === 'baja') {
                prioridadBadge = 'badge';
                prioridadTexto = 'ğŸŸ¢ Baja';
              } else if (ticket.prioridad === 'media') {
                prioridadBadge = 'badge-warning';
                prioridadTexto = 'ğŸŸ¡ Media';
              } else if (ticket.prioridad === 'alta') {
                prioridadBadge = 'badge-primary';
                prioridadTexto = 'ğŸŸ  Alta';
              } else if (ticket.prioridad === 'urgente') {
                prioridadBadge = 'badge-danger';
                prioridadTexto = 'ğŸ”´ Urgente';
              }
            %>
              <tr>
                <td><strong>#<%= ticket.id %></strong></td>
                <% if (esSKN) { %>
                  <td><%= ticket.empresa_nombre %></td>
                <% } %>
                <td><%= ticket.titulo %></td>
                <td><%= ticket.solicitante_nombre %></td>
                <td><span class="badge <%= estadoBadge %>"><%= estadoTexto %></span></td>
                <td><span class="badge <%= prioridadBadge %>"><%= prioridadTexto %></span></td>
                <td><%= ticket.asignado_nombre || 'âšª Sin asignar' %></td>
                <td><%= new Date(ticket.fecha_creacion).toLocaleDateString('es-AR') %></td>
                <td>
                  <a href="/tickets/<%= ticket.id %>" class="btn btn-sm">ğŸ‘ï¸ Ver</a>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } %>
  </main>

  <%- include('../partials/footer') %>
</body>
</html>
